version: '3.8'

# ==============================================================================
# AI Prompt Builder - Docker Compose Configuration
# ==============================================================================
# Production deployment configuration
# Usage: docker compose -f docker/docker-compose.yml up -d
# ==============================================================================

services:
  # ----------------------------------------------------------------------------
  # Main Application Service
  # ----------------------------------------------------------------------------
  app:
    build:
      context: ..
      dockerfile: docker/Dockerfile.dev-simple
      args:
        NODE_ENV: development

    container_name: ai-prompt-builder

    restart: unless-stopped

    ports:
      - "3322:3322"

    environment:
      # Application Configuration
      NODE_ENV: production
      PORT: 3000
      NEXT_TELEMETRY_DISABLED: 1

      # Database Configuration
      DATABASE_URL: file:/app/data/prompts.db

      # Optional: Skip migrations/seeding
      SKIP_MIGRATIONS: ${SKIP_MIGRATIONS:-false}
      SKIP_SEED: ${SKIP_SEED:-false}

      # API Keys (if needed)
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}

      # Application Settings
      NEXT_PUBLIC_APP_NAME: ${NEXT_PUBLIC_APP_NAME:-AI Prompt Builder}
      NEXT_PUBLIC_APP_VERSION: ${NEXT_PUBLIC_APP_VERSION:-1.0.0}

    volumes:
      # Persistent SQLite database
      - prompt-data:/app/data

      # Optional: Mount custom configuration
      # - ./config:/app/config:ro

    networks:
      - prompt-network

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 3s
      start_period: 40s
      retries: 3

    # Resource limits (adjust based on your needs)
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# ==============================================================================
# Volumes
# ==============================================================================
volumes:
  prompt-data:
    driver: local

# ==============================================================================
# Networks
# ==============================================================================
networks:
  prompt-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
